<!DOCTYPE html>
<html lang="en" xmlns:th="https://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="/styles/cascade.css">
</head>

<body>
<header>
    <h1><img src="" width="50" height="50"/><a href="index.html">
        World Conquer
    </a></h1>
</header>
<nav>
    <ul>
        <li><a href="/">Home</a></li>
        <li><a href="/main">main</a></li>
        <li><a href="index">News</a></li>
        <li><a href="index">My Account</a></li>
        <li><a href="index">Contacts</a></li>
    </ul>
</nav>

<aside id="left">카테고리</aside>

<section id="main">
    <article id="article1">
        <iframe name="iframe1" src="computer.html" width="440" height="300" seamless></iframe>
    </article>
</section>

<div id="right">
    <div id="login">
        <h4>Log In</h4>
        <form action="#">
            아이디
            <input type="text" id="email-input"/><br/>
            패스워드
            <input type="password" id="password-input"/><br/>
            <input type="submit" value="로그인" id="auth-request"/>
            <input type="reset" value="초기화"/><br/>
        </form>
        <a href="/register" id="register">회원가입</a>
        <a href="#" id="forgot">비밀번호분실</a>
    </div>
</div>

<footer>
    <div class="footerContent">
        Copyright (c)
    </div>
</footer>

<script>
    const emailInput = document.getElementById("email-input");
    const passwordInput = document.getElementById("password-input");
    const submitBtn = document.getElementById("auth-request");
    const authForm = document.getElementById("right");

    async function render() {
        if (localStorage.getItem("token") !== null) {
            while (authForm.hasChildNodes()) {
                authForm.removeChild(authForm.firstChild);
            }

            const response = await fetch("http://localhost:8080/user/me",
                {
                    headers: {
                        "Authorization": `${localStorage.getItem("token")}`
                    }
                }
            );

            const {id, email} = await response.json();
            authForm.innerHTML = `
                <div>
                    ${id}
                    <br>
                    ${email}
                    <button onclick="logout()">로그아웃</button>
                </div>
            `
        }
    }

    render();

    async function logout() {
        localStorage.clear();
        window.location.reload();
    }

    submitBtn.addEventListener("click", async (ev) => {
        ev.preventDefault();
        const requestUser = {
            email: emailInput.value,
            password: passwordInput.value
        };
        fetch("http://127.0.0.1:8080/auth/login",
            {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestUser),
            })
            .then(async response => {
                const res = await response.json();
                const {accessToken, tokenType} = res;
                await localStorage.setItem("token", `${tokenType} ${accessToken}`)
            })
            .catch(error => console.log(error));
    });
</script>
</body>

</html>